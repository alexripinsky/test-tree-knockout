function Alert(a,b,c){this.header=a.header,this.text=a.text,this.storage=b,this.time=5e3,this["class"]="alert-warning",a.hasOwnProperty("class")&&(this["class"]=a["class"]),c&&(this.time=c),self=this,setTimeout(function(){self.storage.remove(self)},this.time)}function TreeNodeView(){this.isSelected=ko.observable(!1),this.isShow=ko.observable(!0),this.showChildren=ko.observable(!0)}function TreeNode(a,b){this.children=ko.observableArray(),this.data=a,this.data.name=ko.observable(this.data.name),this.parent=b,this.depth=0,b instanceof TreeNode&&(this.depth=b.depth+1),this.add=function(a){var b=new TreeNode(a,this);return this.children.push(b),b},TreeNodeView.apply(this)}function TreeView(a,b,c,d){this.tree=a,this.list=b,this.listSubscriptions=[],this.renderType=c(),this.localStorageKey=d;var e=this;onBeforeUnloadCallStack.push(function(){e.saveToLocalStorage()})}TreeNodeView.prototype.toggleSelection=function(){return vm.settings.selectedNode()instanceof TreeNode&&vm.settings.selectedNode()!==this&&vm.settings.selectedNode().isSelected(!1),this.isSelected()?vm.settings.selectedNode({}):vm.settings.selectedNode(this),this.isSelected(!this.isSelected()),this.isSelected()},TreeNodeView.prototype.toggleChildren=function(){function a(b,c){if(b.length>0)for(var d=0,e=b.length;e>d;d++)b[d].isShow(c),b[d].showChildren(!0),b[d].children().length>0&&a(b[d].children(),c)}var b=!this.showChildren();return a(this.children(),b),this.showChildren(b),this.showChildren()},TreeNode.prototype=Object.create(TreeNodeView.prototype),TreeView.prototype.render=function(){switch(this.list.removeAll(),this.renderType){case"0":ko.utils.arrayPushAll(this.list,this.renderRecursive(this.tree));break;default:case"1":ko.utils.arrayPushAll(this.list,this.renderIterative())}for(var a=0,b=this.listSubscriptions.length;b>a;a++)this.listSubscriptions[a].dispose();for(var a=0,b=this.list().length;b>a;a++)this.listSubscriptions.push(this.list()[a].data.name.subscribe(function(a){""==a&&(vm.settings.selectedNode().data.name("Node"),vm.alerts.push(new Alert({header:"Warning",text:"Enter Node Name"},vm.alerts)))}));return this.list},TreeView.prototype.renderRecursive=function(a){function b(a,c){if(c.push(a),a.children().length>0)for(var d=0,e=a.children().length;e>d;d++)b(a.children()[d],c)}for(var c=[],d=0,e=a().length;e>d;d++)b(a()[d],c);return c},TreeView.prototype.renderIterative=function(){var a=[],b=[];for(ko.utils.arrayPushAll(a,this.tree());a.length>0;){if(b.push(a[0]),a[0].children().length>0)for(var c=0,d=a[0].children().length;d>c;c++)a.push(a[0].children()[c]);a.splice(0,1)}return b},TreeView.prototype.prepereToSerializeNode=function(a){var b={};b.data={};for(var c in a.data)"function"==typeof a.data[c]?b.data[c]=a.data[c]():b.data[c]=a.data[c];b.children=[];for(var d=0,e=a.children().length;e>d;d++)b.children.push(this.prepereToSerializeNode(a.children()[d]));return b},TreeView.prototype.serializeTree=function(){for(var a=[],b=0,c=this.tree().length;c>b;b++)a.push(this.prepereToSerializeNode(this.tree()[b]));return JSON.stringify(a)},TreeView.prototype.saveToLocalStorage=function(){return window.localStorage.setItem(this.localStorageKey,this.serializeTree())},TreeView.prototype.loadFromLocalStorage=function(){function a(b,c){for(var d=new TreeNode({name:b.data.name},c),e=0,f=b.children.length;f>e;e++)d.children.push(a(b.children[e],d));return d}var b=window.localStorage.getItem(this.localStorageKey),c=[];if(null!==b){b=JSON.parse(b);for(var d=0,e=b.length;e>d;d++)c.push(a(b[d],this.tree))}return this.tree.removeAll(),ko.utils.arrayPushAll(this.tree,c),this.tree};var vm={treeList:ko.observableArray(),tree:ko.observableArray(),alerts:ko.observableArray(),settings:{renderType:ko.observable("0"),selectedNode:ko.observable({}),inputs:{newNode:ko.observable(""),changeNode:ko.observable("")},buttons:{AddRootNode:function(){var a=null;return""!==vm.settings.inputs.newNode()?(a=new TreeNode({name:vm.settings.inputs.newNode()},vm.tree),vm.tree.push(a),vm.treeView.render()):vm.alerts.push(new Alert({header:"Warning",text:"Enter Node Name"},vm.alerts)),a},AddChildNode:function(){var a=null;return vm.settings.selectedNode()instanceof TreeNode?""!==vm.settings.inputs.newNode()?(a=vm.settings.selectedNode().add({name:vm.settings.inputs.newNode()}),vm.treeView.render()):vm.alerts.push(new Alert({header:"Warning",text:"Enter Node Name"},vm.alerts)):vm.alerts.push(new Alert({header:"Warning",text:"Select Node"},vm.alerts)),a},RemoveNode:function(){var a=vm.settings.selectedNode(),b=!1;return vm.settings.selectedNode()instanceof TreeNode&&(vm.settings.selectedNode({}),a.parent instanceof TreeNode?a.parent.children.remove(a):a.parent.remove(a),vm.treeView.render(),b=!0),b}}}},onBeforeUnloadCallStack=[];window.onbeforeunload=function(){for(var a=0,b=window.onBeforeUnloadCallStack.length;b>a;a++)window.onBeforeUnloadCallStack[a]()},vm.treeView=new TreeView(vm.tree,vm.treeList,vm.settings.renderType,"MyTreeStorage"),jQuery(document).ready(function(){ko.applyBindings(vm),vm.treeView.loadFromLocalStorage(),vm.treeView.render()});